<!DOCTYPE html>
<html>
<head>
    <title>Smart Tourist Map of Armenia</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 380px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #sidebar-header h2 {
            margin-bottom: 5px;
            font-size: 24px;
        }

        #sidebar-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .filters-section {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .clear-filters {
            width: 100%;
            padding: 10px;
            background: #e9ecef;
            border: none;
            border-radius: 6px;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .clear-filters:hover {
            background: #dee2e6;
        }

        .places-section {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .places-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .places-header h3 {
            color: #495057;
            font-size: 16px;
        }

        .places-count {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #495057;
        }

        #placesList {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        .place-item {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .place-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .place-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .place-info {
            flex: 1;
        }

        .place-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .place-meta {
            display: flex;
            gap: 8px;
            font-size: 12px;
            color: #6c757d;
            flex-wrap: wrap;
        }

        .place-region {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .place-rating {
            color: #ffc107;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        .trip-planner {
            border-top: 2px solid #dee2e6;
            padding: 20px;
            background: white;
        }

        .trip-planner h4 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
            color: #6c757d;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .interests-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .interest-tag {
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .interest-tag.selected {
            background: #667eea;
            color: white;
        }

        .btn-primary {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .trip-result {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
        }

        .trip-day {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .trip-day h5 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .trip-place {
            padding: 5px 10px;
            margin: 3px 0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .trip-place:hover {
            background: #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }

        .leaflet-popup-content {
            min-width: 200px;
        }

        .popup-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .popup-category {
            color: #667eea;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .popup-rating {
            color: #ffc107;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h2><i class="fas fa-map-marked-alt"></i> Smart Tourist Map</h2>
        <p>Discover the beauty of Armenia</p>
    </div>

    <div class="filters-section">
        <div class="filter-group">
            <label><i class="fas fa-map-marker-alt"></i> Region</label>
            <select id="regionFilter" class="filter-select">
                <option value="">All Regions</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-tag"></i> Category</label>
            <select id="categoryFilter" class="filter-select">
                <option value="">All Categories</option>
            </select>
        </div>

        <button id="clearFilters" class="clear-filters">
            <i class="fas fa-times"></i> Clear Filters
        </button>
    </div>

    <div class="places-section">
        <div class="places-header">
            <h3><i class="fas fa-list"></i> Places</h3>
            <span id="placesCount" class="places-count">0</span>
        </div>
        <div id="placesList"></div>
    </div>

    <div class="trip-planner">
        <h4><i class="fas fa-robot"></i> AI Trip Planner</h4>
        <form id="tripPlannerForm">
            <div class="form-group">
                <label>Number of Days</label>
                <input type="number" id="days" class="form-control" min="1" max="10" value="2">
            </div>

            <div class="form-group">
                <label>Budget</label>
                <select id="budget" class="form-control">
                    <option value="low">üí∞ Low</option>
                    <option value="medium" selected>üí∏ Medium</option>
                    <option value="high">üíé High</option>
                </select>
            </div>

            <div class="form-group">
                <label>Interests (click to select)</label>
                <div id="interests" class="interests-group">
                    <!-- Will be populated from API -->
                </div>
            </div>

            <div class="form-group">
                <label>Transport</label>
                <select id="transport" class="form-control">
                    <option value="car">üöó Car</option>
                    <option value="public">üöå Public Transport</option>
                    <option value="tour">üöê Tour Bus</option>
                </select>
            </div>

            <button type="submit" class="btn-primary" id="planTripBtn">
                <i class="fas fa-magic"></i> Generate Smart Trip
            </button>
        </form>

        <div id="tripResult" class="trip-result"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // Initialize map
    var map = L.map('map').setView([40.1792, 44.4991], 8);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Initialize marker cluster group
    var markersLayer = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    }).addTo(map);

    var markers = [];
    var allPlaces = [];

    // Helper function to extract data from paginated response
    function extractData(response) {
        if (response && response.results) {
            return response.results;
        }
        return response || [];
    }

    // Load regions dropdown
    fetch('/api/regions/')
        .then(response => response.json())
        .then(data => {
            const regions = extractData(data);
            console.log('Regions loaded:', regions);
            const select = document.getElementById('regionFilter');
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading regions:', error));

    // Load categories dropdown and interests
    fetch('/api/categories/')
        .then(response => response.json())
        .then(data => {
            const categories = extractData(data);
            console.log('Categories loaded:', categories);
            
            // Populate category filter dropdown
            const categorySelect = document.getElementById('categoryFilter');
            const interestsDiv = document.getElementById('interests');
            
            categories.forEach(cat => {
                // Add to filter dropdown
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
                
                // Add to interests
                const tag = document.createElement('span');
                tag.className = 'interest-tag';
                tag.dataset.value = cat.name.toLowerCase();
                tag.innerHTML = `${cat.icon || 'üìç'} ${cat.name}`;
                tag.onclick = function() {
                    this.classList.toggle('selected');
                };
                interestsDiv.appendChild(tag);
            });
        })
        .catch(error => console.error('Error loading categories:', error));

    // Load places function
    function loadPlaces() {
        const region = document.getElementById('regionFilter').value;
        const category = document.getElementById('categoryFilter').value;
        
        let url = '/api/places/';
        let params = [];
        if (region) params.push('region=' + region);
        if (category) params.push('category=' + category);
        if (params.length) url += '?' + params.join('&');
        
        console.log('Loading places from:', url);
        
        // Show loading
        document.getElementById('placesList').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading places...</div>';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const places = extractData(data);
                console.log('Places loaded:', places);
                
                // Clear existing markers
                markersLayer.clearLayers();
                markers = [];
                allPlaces = places;
                
                // Update count
                document.getElementById('placesCount').textContent = places.length;
                
                // Clear and rebuild places list
                const listDiv = document.getElementById('placesList');
                listDiv.innerHTML = '';
                
                if (places.length === 0) {
                    listDiv.innerHTML = '<div class="loading">No places found</div>';
                    return;
                }
                
                places.forEach(place => {
                    // Create custom marker icon
                    const icon = L.divIcon({
                        html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${place.category_icon || 'üìç'}</div>`,
                        className: 'custom-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });
                    
                    // Create marker
                    const marker = L.marker([place.latitude, place.longitude], {icon: icon});
                    
                    // Create popup content
                    const popupContent = `
                        <div>
                            ${place.image_url ? `<img src="${place.image_url}" style="width:100%; height:100px; object-fit:cover; border-radius:4px; margin-bottom:8px;">` : ''}
                            <div class="popup-title">${place.name}</div>
                            <div class="popup-category">${place.category_icon || ''} ${place.category_name || 'Unknown'}</div>
                            <div style="font-size:12px; margin-bottom:5px;">${place.description ? place.description.substring(0, 100) + '...' : 'No description'}</div>
                            <div class="popup-rating"><i class="fas fa-star"></i> ${place.rating || '0'}</div>
                            ${place.entrance_fee ? `<div><i class="fas fa-ticket-alt"></i> ${place.entrance_fee}</div>` : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                    
                    markers.push({marker: marker, place: place});
                    
                    // Add to sidebar list
                    const item = document.createElement('div');
                    item.className = 'place-item';
                    item.onclick = () => {
                        map.setView([place.latitude, place.longitude], 12);
                        marker.openPopup();
                    };
                    
                    item.innerHTML = `
                        <div class="place-icon">${place.category_icon || 'üìç'}</div>
                        <div class="place-info">
                            <div class="place-name">${place.name}</div>
                            <div class="place-meta">
                                <span class="place-region">${place.region_name || 'Unknown'}</span>
                                <span class="place-rating"><i class="fas fa-star"></i> ${place.rating || '0'}</span>
                            </div>
                        </div>
                    `;
                    
                    listDiv.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error loading places:', error);
                document.getElementById('placesList').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error loading places</div>';
            });
    }

    // Event listeners for filters
    document.getElementById('regionFilter').addEventListener('change', loadPlaces);
    document.getElementById('categoryFilter').addEventListener('change', loadPlaces);
    
    document.getElementById('clearFilters').addEventListener('click', () => {
        document.getElementById('regionFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        loadPlaces();
    });

    // Trip planner form
    document.getElementById('tripPlannerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const days = document.getElementById('days').value;
        const budget = document.getElementById('budget').value;
        const transport = document.getElementById('transport').value;
        const interests = Array.from(document.querySelectorAll('.interest-tag.selected'))
            .map(tag => tag.dataset.value);
        
        const resultDiv = document.getElementById('tripResult');
        const planBtn = document.getElementById('planTripBtn');
        
        // Show loading
        resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Planning your trip...</div>';
        planBtn.disabled = true;
        
        fetch('/api/plan_trip/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days, budget, interests, transport})
        })
        .then(response => response.json())
        .then(data => {
            planBtn.disabled = false;
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error-message">${data.error}</div>`;
                return;
            }
            
            let html = '';
            data.forEach(day => {
                html += `<div class="trip-day">`;
                html += `<h5>Day ${day.day}</h5>`;
                day.places.forEach(place => {
                    html += `<div class="trip-place">üìç ${place.name} (${place.region})</div>`;
                });
                html += `</div>`;
            });
            
            resultDiv.innerHTML = html;
        })
        .catch(error => {
            planBtn.disabled = false;
            resultDiv.innerHTML = '<div class="error-message">Error planning trip</div>';
            console.error('Error:', error);
        });
    });

    // Initial load
    loadPlaces();
</script>
</body>
</html>